<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="../../../testing/xspec-assurance.sch"?>
<x:description xmlns:mx="http://csrc.nist.gov/ns/csd/metaschema-xslt"
    xmlns:mv="http://csrc.nist.gov/ns/csd/metaschema-xslt" xmlns="http://example.com/ns/computer"
    xmlns:c="http://example.com/ns/computer" xmlns:x="http://www.jenitennison.com/xslt/xspec"
    xmlns:xs="http://www.w3.org/2001/XMLSchema" stylesheet="current/computer_inspector.xsl"
    xslt-version="3.0">

    <x:scenario label="Missing things are reported properly as missing">
        <x:scenario label="An anonymous empty blank computer">
            <x:context mode="validate">
                <computer/>
            </x:context>
            <x:expect label="is marked as missing required attributes and contents">
                <computer>
                    <mx:report cf="gix.422" test="empty(@id)" cat="required flag"
                        xpath="/computer"><mx:gi>computer</mx:gi> requires <mx:gi>@id</mx:gi>.</mx:report>
                </computer>
            </x:expect>
        </x:scenario>
        <x:scenario label="A computer with a motherboard only">
            <x:context mode="validate">
                <computer id="0000">
                    <motherboard/>
                </computer>
            </x:context>
            <x:expect label="is marked as missing required attributes and contents">
                <computer id="0000">
                    <motherboard>
                        <mx:report cf="gix.329" test="empty(type)" cat="required contents"
                            xpath="/computer/motherboard">
                            <mx:gi>motherboard</mx:gi> requires <mx:gi>type</mx:gi>.</mx:report>
                        <mx:report cf="gix.329" test="empty(memory)" cat="required contents"
                            xpath="/computer/motherboard"><mx:gi>motherboard</mx:gi> requires <mx:gi>memory</mx:gi>.</mx:report>
                    </motherboard>
                </computer>
            </x:expect>
        </x:scenario>

    </x:scenario>

    <x:scenario label="Things out of place are detected and reported">
        <x:scenario label="A computer with incorrect contents - something unknown">
            <x:context mode="validate">
                <computer id="0000">
                    <unknown/>
                </computer>
            </x:context>
            <x:expect label="reports its questionable content">
                <computer xmlns="http://example.com/ns/computer" id="0000">
                    <unknown>
                        <mx:report cf="av.60" test="exists(.)" cat="unmatched"
                            xpath="/computer/unknown">Unrecognized element <mx:gi>unknown</mx:gi>.</mx:report>
                    </unknown>
                </computer>
            </x:expect>
        </x:scenario>
        <x:scenario label="A computer with incorrect contents - something known">
            <x:context mode="validate">
                <computer id="0000">
                    <computer/>
                </computer>
            </x:context>
            <x:expect label="reports its questionable content">
                <computer xmlns="http://example.com/ns/computer" id="0000">
                    <computer>
                        <mx:report cf="computer_inspector.xsl" test="exists(.)" cat="context"
                            xpath="/computer/computer">
                            <mx:gi>computer</mx:gi> is not expected here.</mx:report>
                    </computer>
                </computer>
            </x:expect>
        </x:scenario>
        <x:scenario label="A computer/motherboard with incorrect contents - an extra">
            <x:context mode="validate">
                <computer id="0000">
                    <motherboard>
                        <type>Z</type>
                        <type>Z</type>
                        <memory>
                            <product-name>FAN-C DIMM</product-name>
                            <byte-size>4</byte-size>
                        </memory>
                    </motherboard>
                </computer>
            </x:context>
            <x:expect label="reports its questionable content">
                <computer id="0000">
                    <motherboard>
                        <type>Z</type>
                        <type><mx:report cf="gix.244" test="count(. | preceding-sibling::type) gt 1" cat="cardinality"
                            xpath="/computer/motherboard/type[2]"><mx:gi>type</mx:gi> appears too many times: 1 maximum is permitted.</mx:report>Z</type>
                        <memory>
                            <product-name>FAN-C DIMM</product-name>
                            <byte-size>4</byte-size>
                        </memory>
                    </motherboard>
                </computer>
            </x:expect>
        </x:scenario>
        <x:scenario label="A computer/motherboard with contents out of prescribed order">
            <x:context mode="validate">
                <computer id="0000">
                    <motherboard>
                        <memory>
                            <product-name>FAN-C DIMM</product-name>
                            <byte-size>4</byte-size>
                        </memory>
                        <type>Z</type>
                    </motherboard>
                </computer>
            </x:context>
            <x:expect label="reports an error for an element out of position">
                <computer id="0000">
                    <motherboard>
                        <memory>
                            <product-name>FAN-C DIMM</product-name>
                            <byte-size>4</byte-size>
                        </memory>
                        <type>
                            <mx:report cf="gix.287"
                                test="exists( preceding-sibling::cpu | preceding-sibling::ata-socket | preceding-sibling::memory | preceding-sibling::expansion-card )"
                                cat="ordering" xpath="/computer/motherboard/type">
                                <mx:gi>type</mx:gi> is unexpected following <mx:gi>cpu</mx:gi>, <mx:gi>ata-socket</mx:gi>, <mx:gi>memory</mx:gi>, or <mx:gi>expansion-card</mx:gi>.</mx:report>Z</type>

                    </motherboard>
                </computer>
            </x:expect>
        </x:scenario>
    </x:scenario>

    <x:scenario label="Reports are delivered - pinpointing nodes in context using mode 'test'">
        <x:scenario label="For unwarranted content">
            <x:context mode="test" select="/c:computer/c:motherboard/c:type[2]">
                <!-- no support for default xpath ns -->
                <computer id="0000">
                    <motherboard>
                        <type>Z</type>
                        <type>Z</type>
                        <memory>
                            <product-name>FAN-C DIMM</product-name>
                            <byte-size>4</byte-size>
                        </memory>
                    </motherboard>
                </computer>
            </x:context>
            <x:expect label="an error is reported">
                <mx:report cf="gix.244" test="count(. | preceding-sibling::type) gt 1"
                    cat="cardinality" xpath="/computer/motherboard/type[2]">
                    <mx:gi>type</mx:gi> appears too many times: 1 maximum is permitted.</mx:report>
            </x:expect>
        </x:scenario>
        <x:scenario label="For content out of position">
            <x:context mode="test" select="/c:computer/c:motherboard/c:type">
                <computer id="0000">
                    <motherboard>
                        <memory>
                            <product-name>FAN-C DIMM</product-name>
                            <byte-size>4</byte-size>
                        </memory>
                        <type>Z</type>
                    </motherboard>
                </computer>
            </x:context>
            <x:expect label="an error is reported">
                <mx:report cf="gix.287"
                    test="exists( preceding-sibling::cpu | preceding-sibling::ata-socket | preceding-sibling::memory | preceding-sibling::expansion-card )"
                    cat="ordering" xpath="/computer/motherboard/type">
                    <mx:gi>type</mx:gi> is unexpected following <mx:gi>cpu</mx:gi>, <mx:gi>ata-socket</mx:gi>, <mx:gi>memory</mx:gi>, or <mx:gi>expansion-card</mx:gi>.</mx:report>
            </x:expect>
        </x:scenario>

    </x:scenario>

    <!-- XXX next up: tracking down and testing each of the template types generated for or copied into inspector XSLT
           including model//choice/* use cases
           maybe make an invalid/pathological.xml to maintain out of line and select from for mode 'test' -->
    <!-- XXX then: wiring in and testing datatypes following XSD generator -->
    <!-- XXX then: implementing the constraints checking!  -->

</x:description>
